<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .container {
            visibility: hidden;
        }
    </style>
</head>

<body>
    <div class="container">
        <video id="video"></video>
        <canvas id="motion"></canvas>
        <span>
	`Score: <span id="score">?</span>
        </span>

    </div>
    <ul id="recordingslist2"></ul>
    <script src="camLibrary.js"></script>
    <!--motion detection javascript functionlities  -->
    <script>
    </script>
    <!--firebase retrieving javascript functionalities   -->
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
    <script>
        //fire firebase
        var config = {
            apiKey: "AIzaSyD-hYIApkFby9GRHEe6RVQ8gs-YKZylY44",
            authDomain: "glenda-174ee.firebaseapp.com",
            databaseURL: "https://glenda-174ee.firebaseio.com",
            projectId: "glenda-174ee",
            storageBucket: "glenda-174ee.appspot.com",
            messagingSenderId: "1035646158453"
        };
        firebase.initializeApp(config);

        //motion detection DOM
        let video = document.getElementById('video');
        let canvas = document.getElementById('motion');
        let score = document.getElementById('score');
        const audio = document.querySelector('audio');

        localStorage.setItem('number', 1)
        var item = localStorage.getItem('number');


        function initSuccess() {
            DiffCamEngine.start();
        }

        function initError() {
            alert('Something went wrong.');
        }

        function capture(payload) {
            score.textContent = payload.score;
            if (payload.score > 200) {
                spitFire();
                DiffCamEngine.stop();
            }
        }

        DiffCamEngine.init({
            video: video,
            motionCanvas: canvas,
            initSuccessCallback: initSuccess,
            initErrorCallback: initError,
            captureCallback: capture
        });

        var storageDatabase = firebase.database().ref();
        var storage = firebase.storage();

        function spitFire(number) {
            storageDatabase.once('value')
                .then(data => {
                    let newArray = [];
                    data.forEach((value, index) => {
                        let allAudio = value.val();
                        newArray.push(allAudio.name)
                    })
                    let keyLength = newArray.length;
                    let lastFile = newArray
                    return {
                        name: lastFile,
                        length: keyLength
                    }
                })
                .then(data => {
                    let ele = data.name.slice(-1);
                    storage.ref().child(`sound/${ele}`).getDownloadURL()
                        .then(function(url) {
                            let li = `<li><audio controls class='audio'>
                            <source src="${url}" type="audio/wav">
                                </audio></li>`
                            document.querySelector('ul').insertAdjacentHTML('beforeend', li)
                            document.querySelector('audio').play();
                        })

                })
                .catch(error => {
                    console.log(error)
                })
        }


        storageDatabase.on('child_added', snap => {
            let snapshot = snap.val();
            let name = snapshot.name;
            storage.ref().child(`sound/${name}`).getDownloadURL()
                .then(function(url) {
                    let li = `<li><audio controls class='audio'>
                            <source src="${url}" type="audio/wav">
                                </audio></li>`
                    document.querySelector('ul').insertAdjacentHTML('beforeend', li)
                    document.querySelector('audio').play();
                })

        })
    </script>
</body>

</html>